import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from './ui/card';
import { Button } from './ui/button';
import { Badge } from './ui/badge';
import { 
  FileText, Calendar, Trash2, Eye, Download, 
  User, Trophy, BarChart3, RefreshCw, Target
} from 'lucide-react';
import { useAuth } from '../contexts/AuthContext';
import AssessmentReport from './AssessmentReport';
import BenchmarkHistory from './BenchmarkHistory';

const SavedReports = () => {
  const [activeTab, setActiveTab] = useState('reports'); // 'reports' or 'benchmarks'
  const [savedReports, setSavedReports] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedReport, setSelectedReport] = useState(null);
  const [showReportModal, setShowReportModal] = useState(false);
  const { getSavedReports, deleteSavedReport, user } = useAuth();

  useEffect(() => {
    loadSavedReports();
  }, []);

  const loadSavedReports = async () => {
    setLoading(true);
    const result = await getSavedReports();
    if (result.success) {
      setSavedReports(result.reports);
    } else {
      console.error('Failed to load saved reports:', result.error);
    }
    setLoading(false);
  };\n\n  const handleDeleteReport = async (reportId) => {\n    if (window.confirm('Are you sure you want to delete this report?')) {\n      const result = await deleteSavedReport(reportId);\n      if (result.success) {\n        setSavedReports(prev => prev.filter(report => report.id !== reportId));\n      } else {\n        alert('Failed to delete report: ' + result.error);\n      }\n    }\n  };\n\n  const handleViewReport = (report) => {\n    setSelectedReport(report);\n    setShowReportModal(true);\n  };\n\n  const getReportTypeIcon = (type) => {\n    switch (type) {\n      case 'startup': return <Trophy className=\"w-4 h-4\" />;\n      case 'milestone': return <BarChart3 className=\"w-4 h-4\" />;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getReportTypeColor = (type) => {\n    switch (type) {\n      case 'startup': return 'bg-purple-100 text-purple-800';\n      case 'milestone': return 'bg-green-100 text-green-800';\n      default: return 'bg-blue-100 text-blue-800';\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex justify-center items-center h-64\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-[--text-navy]\">Saved Assessment Reports</h2>\n          <p className=\"text-[--text-gray]\">Access and manage your saved player assessment reports</p>\n        </div>\n        <Button onClick={loadSavedReports} variant=\"outline\">\n          <RefreshCw className=\"w-4 h-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      {/* User Info */}\n      <Card className=\"professional-card\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center\">\n              <User className=\"w-6 h-6 text-white\" />\n            </div>\n            <div>\n              <h3 className=\"font-semibold\">{user?.full_name}</h3>\n              <p className=\"text-sm text-gray-600\">\n                {user?.is_coach ? 'Coach/Professional' : 'Player/Parent'} â€¢ {savedReports.length} saved reports\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Reports List */}\n      {savedReports.length === 0 ? (\n        <Card className=\"professional-card text-center p-12\">\n          <CardContent>\n            <FileText className=\"w-16 h-16 mx-auto mb-4 text-[--text-muted]\" />\n            <h3 className=\"text-2xl font-semibold mb-2\">No Saved Reports</h3>\n            <p className=\"text-[--text-muted]\">\n              Complete player assessments and save reports to see them here.\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {savedReports.map((report) => (\n            <Card key={report.id} className=\"professional-card hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    {getReportTypeIcon(report.report_type)}\n                    <CardTitle className=\"text-lg\">{report.title}</CardTitle>\n                  </div>\n                  <Badge className={getReportTypeColor(report.report_type)}>\n                    {report.report_type.charAt(0).toUpperCase() + report.report_type.slice(1)}\n                  </Badge>\n                </div>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <User className=\"w-4 h-4 text-gray-500\" />\n                    <span className=\"font-medium\">{report.player_name}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n                    <Calendar className=\"w-4 h-4\" />\n                    <span>{new Date(report.saved_at).toLocaleDateString()}</span>\n                  </div>\n                  {report.notes && (\n                    <p className=\"text-sm text-gray-600 line-clamp-2\">{report.notes}</p>\n                  )}\n                </div>\n\n                <div className=\"flex gap-2\">\n                  <Button \n                    onClick={() => handleViewReport(report)}\n                    size=\"sm\" \n                    className=\"flex-1\"\n                  >\n                    <Eye className=\"w-4 h-4 mr-1\" />\n                    View\n                  </Button>\n                  <Button \n                    onClick={() => handleDeleteReport(report.id)}\n                    size=\"sm\" \n                    variant=\"outline\"\n                    className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {/* Report Viewer Modal */}\n      {showReportModal && selectedReport && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-lg max-w-6xl max-h-[90vh] overflow-y-auto w-full\">\n            <div className=\"sticky top-0 bg-white border-b p-4 flex justify-between items-center\">\n              <h2 className=\"text-xl font-bold\">{selectedReport.title}</h2>\n              <div className=\"flex gap-2\">\n                <Button\n                  onClick={() => {\n                    // Trigger print of the report\n                    window.print();\n                  }}\n                  variant=\"outline\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Print Report\n                </Button>\n                <Button\n                  onClick={() => {\n                    setShowReportModal(false);\n                    setSelectedReport(null);\n                  }}\n                  variant=\"outline\"\n                >\n                  Close\n                </Button>\n              </div>\n            </div>\n            <div className=\"p-6\">\n              {/* Reconstruct the assessment report from saved data */}\n              <AssessmentReport\n                playerData={selectedReport.report_data.playerData}\n                previousAssessments={selectedReport.report_data.previousAssessments || []}\n                showComparison={true}\n                isStartupReport={selectedReport.report_type === 'startup'}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default SavedReports;"